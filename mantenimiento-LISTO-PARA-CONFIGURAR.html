<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n de Mantenimiento</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-database-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* LOGIN SCREEN */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 100%;
        }

        .login-box h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-primary {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            padding: 8px 16px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            padding: 8px 16px;
            background: #ffc107;
            color: #333;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-info {
            padding: 8px 16px;
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .btn-info:hover {
            background: #138496;
        }

        /* MAIN APP */
        .app-container {
            display: none;
        }

        .header {
            background: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 1.8em;
        }

        .user-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .user-badge {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .btn-logout {
            padding: 10px 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-logout:hover {
            background: #c82333;
        }

        /* DASHBOARD */
        .dashboard {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .dashboard-card.admin-only {
            border: 2px solid #ffc107;
        }

        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            margin-bottom: 15px;
        }

        .card-icon.blue { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-icon.green { background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); }
        .card-icon.orange { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .card-icon.purple { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .card-icon.red { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .card-icon.teal { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }
        .card-icon.yellow { background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%); }
        .card-icon.pink { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }

        .card-title {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .card-description {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        .admin-badge {
            display: inline-block;
            background: #ffc107;
            color: #333;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-top: 10px;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-header h2 {
            color: #667eea;
            font-size: 1.8em;
        }

        .btn-close {
            background: #dc3545;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-close:hover {
            background: #c82333;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .parts-selection {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .parts-selection .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .parts-list-display {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            min-height: 50px;
        }

        .part-tag {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            margin: 5px;
            font-size: 13px;
        }

        .part-tag .remove-part {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        /* TABLES */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }

        table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .badge-resuelto { background: #d4edda; color: #155724; }
        .badge-no-resuelto { background: #f8d7da; color: #721c24; }
        .badge-en-progreso { background: #fff3cd; color: #856404; }
        .badge-alta { background: #f8d7da; color: #721c24; }
        .badge-media { background: #fff3cd; color: #856404; }
        .badge-baja { background: #d4edda; color: #155724; }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .equipment-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .equipment-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .equipment-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .equipment-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .equipment-stat {
            text-align: center;
        }

        .equipment-stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }

        .equipment-stat-label {
            font-size: 12px;
            color: #666;
        }

        /* LISTA DE ITEMS */
        .items-list {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .item-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .item-entry:hover {
            background: #e9ecef;
        }

        .item-name {
            font-weight: 600;
            color: #333;
        }

        .add-item-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .add-item-form input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 15px;
            }

            .parts-selection {
                flex-direction: column;
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <h1>üîß Gesti√≥n de Mantenimiento</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label>Usuario</label>
                    <input type="text" id="loginUsername" required>
                </div>
                <div class="form-group">
                    <label>Contrase√±a</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn-primary">Iniciar Sesi√≥n</button>
            </form>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="app-container" id="appContainer">
        <div class="header">
            <h1>üîß Sistema de Gesti√≥n de Mantenimiento</h1>
            <div class="user-info">
                <span class="user-badge" id="userBadge"></span>
                <button class="btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <div class="dashboard">
            <h2 style="color: white; margin-bottom: 20px;">Panel de Control</h2>
            <div class="dashboard-grid" id="dashboardGrid">
                <!-- Card 1: Rellenar Informe -->
                <div class="dashboard-card" onclick="openModal('reportModal')">
                    <div class="card-icon blue">üìù</div>
                    <div class="card-title">Rellenar Informe</div>
                    <div class="card-description">Crear un nuevo informe de mantenimiento con todos los detalles de la operaci√≥n realizada</div>
                </div>

                <!-- Card 2: Solicitud de Repuestos -->
                <div class="dashboard-card" onclick="openModal('partsModal')">
                    <div class="card-icon green">üõ†Ô∏è</div>
                    <div class="card-title">Solicitud de Repuestos</div>
                    <div class="card-description">Solicitar materiales y repuestos necesarios para las operaciones de mantenimiento</div>
                </div>

                <!-- Card 3: Informe del D√≠a -->
                <div class="dashboard-card" onclick="openModal('dailyModal')">
                    <div class="card-icon orange">üìÖ</div>
                    <div class="card-title">Informe del D√≠a</div>
                    <div class="card-description">Ver todas las actividades realizadas en el d√≠a anterior</div>
                </div>

                <!-- Card 4: Resumen de Semana -->
                <div class="dashboard-card" onclick="openModal('weeklyModal')">
                    <div class="card-icon purple">üìä</div>
                    <div class="card-title">Resumen de Semana</div>
                    <div class="card-description">Resumen completo de todas las actividades de la semana anterior</div>
                </div>

                <!-- Card 5: Resumen por Equipos -->
                <div class="dashboard-card" onclick="openModal('equipmentModal')">
                    <div class="card-icon teal">‚öôÔ∏è</div>
                    <div class="card-title">Resumen por Equipos</div>
                    <div class="card-description">Historial completo de mantenimiento organizado por equipo</div>
                </div>

                <!-- Card 6: Resumen Solicitudes -->
                <div class="dashboard-card" onclick="openModal('partsRequestsModal')">
                    <div class="card-icon red">üì¶</div>
                    <div class="card-title">Resumen Solicitudes</div>
                    <div class="card-description">Ver todas las solicitudes de repuestos realizadas</div>
                </div>

                <!-- Card 7: Gesti√≥n de Equipos (ADMIN ONLY) -->
                <div class="dashboard-card admin-only" id="adminEquipmentCard" style="display:none;" onclick="openModal('manageEquipmentModal')">
                    <div class="card-icon yellow">üè≠</div>
                    <div class="card-title">Gesti√≥n de Equipos</div>
                    <div class="card-description">Agregar, editar o eliminar equipos de la lista maestra</div>
                    <span class="admin-badge">SOLO ADMIN</span>
                </div>

                <!-- Card 8: Gesti√≥n de Repuestos (ADMIN ONLY) -->
                <div class="dashboard-card admin-only" id="adminPartsCard" style="display:none;" onclick="openModal('managePartsListModal')">
                    <div class="card-icon pink">üìã</div>
                    <div class="card-title">Cat√°logo de Repuestos</div>
                    <div class="card-description">Gestionar el cat√°logo maestro de repuestos disponibles</div>
                    <span class="admin-badge">SOLO ADMIN</span>
                </div>

                <!-- Card 9: Gesti√≥n Tipos de Mantenimiento (ADMIN ONLY) -->
                <div class="dashboard-card admin-only" id="adminTypesCard" style="display:none;" onclick="openModal('manageTypesModal')">
                    <div class="card-icon blue">üîß</div>
                    <div class="card-title">Tipos de Mantenimiento</div>
                    <div class="card-description">Gestionar los tipos de mantenimiento disponibles</div>
                    <span class="admin-badge">SOLO ADMIN</span>
                </div>

                <!-- Card 10: Archivos Excel -->
                <div class="dashboard-card" onclick="openModal('excelAccessModal')" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white;">
                    <div class="card-icon" style="background: rgba(255,255,255,0.3);">üìä</div>
                    <div class="card-title" style="color: white;">Archivos Excel</div>
                    <div class="card-description" style="color: rgba(255,255,255,0.9);">Descargar los archivos Excel completos con todos los datos hist√≥ricos</div>
                </div>

                <!-- Card 11: Gr√°fica de Tareas por Equipos -->
                <div class="dashboard-card" onclick="openModal('chartModal')" style="grid-column: span 2;">
                    <div class="card-icon purple">üìà</div>
                    <div class="card-title">Resumen de Tareas por Equipos</div>
                    <div class="card-description">Visualizaci√≥n gr√°fica del hist√≥rico completo de tareas realizadas en cada equipo</div>
                </div>

                <!-- Card 12: Robert - Asistente IA -->
                <div class="dashboard-card" onclick="openModal('robertModal')" style="grid-column: span 2; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="card-icon" style="background: rgba(255,255,255,0.3);">ü§ñ</div>
                    <div class="card-title" style="color: white;">Robert - Asistente IA</div>
                    <div class="card-description" style="color: rgba(255,255,255,0.9);">An√°lisis inteligente del hist√≥rico: sugerencias de repuestos, informes semanales y predicci√≥n de mantenimientos</div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: RELLENAR INFORME -->
    <div class="modal" id="reportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìù Nuevo Informe de Mantenimiento</h2>
                <button class="btn-close" onclick="closeModal('reportModal')">√ó</button>
            </div>
            <form id="reportForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Fecha</label>
                        <input type="date" id="reportDate" required>
                    </div>
                    <div class="form-group">
                        <label>Hora Inicio</label>
                        <input type="time" id="reportStartTime" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Hora Fin</label>
                        <input type="time" id="reportEndTime" required>
                    </div>
                    <div class="form-group">
                        <label>Tiempo Total (minutos)</label>
                        <input type="number" id="reportTotalTime" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tipo de Mantenimiento</label>
                        <select id="reportType" required>
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Equipo</label>
                        <select id="reportEquipment" required>
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Estado</label>
                        <select id="reportStatus" required>
                            <option value="Resuelto">Resuelto</option>
                            <option value="No Resuelto">No Resuelto</option>
                            <option value="En Progreso">En Progreso</option>
                        </select>
                    </div>
                    <div class="form-group"></div>
                </div>
                <div class="form-group">
                    <label>Descripci√≥n del Trabajo</label>
                    <textarea id="reportDescription" required placeholder="Describe detalladamente el trabajo realizado..."></textarea>
                </div>
                <div class="form-group">
                    <label>Resultados</label>
                    <textarea id="reportResults" required placeholder="Describe los resultados obtenidos..."></textarea>
                </div>
                <div class="form-group">
                    <label>Recambios Utilizados</label>
                    <div class="parts-selection">
                        <div class="form-group">
                            <select id="reportPartsSelect">
                                <option value="">Seleccionar repuesto...</option>
                                <option value="__NUEVO__">üÜï Repuesto Nuevo</option>
                            </select>
                        </div>
                        <button type="button" class="btn-success" onclick="addPartToReport()">‚ûï Agregar</button>
                        <button type="button" class="btn-info" onclick="openPartsRequestFromReport()">üì¶ Solicitar Repuesto</button>
                    </div>
                    <div class="parts-list-display" id="reportPartsList">
                        <small style="color: #666;">Los repuestos seleccionados aparecer√°n aqu√≠</small>
                    </div>
                </div>
                <div class="form-group">
                    <label>Recomendaciones</label>
                    <textarea id="reportRecommendations" placeholder="Recomendaciones para futuras intervenciones..."></textarea>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn-primary">Guardar Informe</button>
                    <button type="button" class="btn-secondary" onclick="closeModal('reportModal')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: SOLICITUD DE REPUESTOS -->
    <div class="modal" id="partsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üõ†Ô∏è Solicitud de Repuestos</h2>
                <button class="btn-close" onclick="closeModal('partsModal')">√ó</button>
            </div>
            <form id="partsForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Fecha de Solicitud</label>
                        <input type="date" id="partsDate" required>
                    </div>
                    <div class="form-group">
                        <label>Prioridad</label>
                        <select id="partsPriority" required>
                            <option value="Alta">Alta</option>
                            <option value="Media">Media</option>
                            <option value="Baja">Baja</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Equipo Relacionado</label>
                    <select id="partsEquipment" required>
                        <option value="">Seleccionar...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Repuesto del Cat√°logo</label>
                    <select id="partsCatalog">
                        <option value="">Seleccionar del cat√°logo...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Descripci√≥n del Repuesto</label>
                    <textarea id="partsDescription" required placeholder="Describe el repuesto necesario (c√≥digo, especificaciones, etc.)..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Cantidad</label>
                        <input type="number" id="partsQuantity" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>Unidad</label>
                        <select id="partsUnit" required>
                            <option value="Pieza">Pieza</option>
                            <option value="Caja">Caja</option>
                            <option value="Metro">Metro</option>
                            <option value="Litro">Litro</option>
                            <option value="Kg">Kg</option>
                            <option value="Set">Set</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Motivo de la Solicitud</label>
                    <textarea id="partsReason" required placeholder="Explica por qu√© se necesita este repuesto..."></textarea>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn-primary">Enviar Solicitud</button>
                    <button type="button" class="btn-secondary" onclick="closeModal('partsModal')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: INFORME DEL D√çA -->
    <div class="modal" id="dailyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìÖ Informe del D√≠a Anterior</h2>
                <button class="btn-close" onclick="closeModal('dailyModal')">√ó</button>
            </div>
            <div class="summary-stats" id="dailyStats"></div>
            <div class="table-container">
                <table id="dailyTable">
                    <thead>
                        <tr>
                            <th>Hora</th>
                            <th>Mec√°nico</th>
                            <th>Equipo</th>
                            <th>Tipo</th>
                            <th>Estado</th>
                            <th>Tiempo</th>
                        </tr>
                    </thead>
                    <tbody id="dailyTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL: RESUMEN SEMANA -->
    <div class="modal" id="weeklyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìä Resumen de la Semana Anterior</h2>
                <button class="btn-close" onclick="closeModal('weeklyModal')">√ó</button>
            </div>
            <div class="summary-stats" id="weeklyStats"></div>
            <div class="filters">
                <div class="filter-group">
                    <label>Filtrar por Tipo</label>
                    <select id="weeklyFilterType" onchange="filterWeeklyReports()">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Filtrar por Estado</label>
                    <select id="weeklyFilterStatus" onchange="filterWeeklyReports()">
                        <option value="">Todos</option>
                        <option value="Resuelto">Resuelto</option>
                        <option value="No Resuelto">No Resuelto</option>
                        <option value="En Progreso">En Progreso</option>
                    </select>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Mec√°nico</th>
                            <th>Equipo</th>
                            <th>Tipo</th>
                            <th>Estado</th>
                            <th>Tiempo</th>
                            <th>Descripci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="weeklyTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL: RESUMEN POR EQUIPOS -->
    <div class="modal" id="equipmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Resumen por Equipos</h2>
                <button class="btn-close" onclick="closeModal('equipmentModal')">√ó</button>
            </div>
            <div class="filters">
                <div class="filter-group">
                    <label>Seleccionar Equipo</label>
                    <select id="equipmentFilterSelect" onchange="filterEquipmentBySelect()">
                        <option value="">Todos los equipos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Buscar Equipo</label>
                    <input type="text" id="equipmentSearch" onkeyup="filterEquipment()" placeholder="Buscar por nombre...">
                </div>
            </div>
            <div id="equipmentList"></div>
        </div>
    </div>

    <!-- MODAL: DETALLE DE EQUIPO -->
    <div class="modal" id="equipmentDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="equipmentDetailTitle"></h2>
                <button class="btn-close" onclick="closeModal('equipmentDetailModal')">√ó</button>
            </div>
            <div class="summary-stats" id="equipmentDetailStats"></div>
            <div class="action-buttons">
                <button class="btn-secondary" onclick="closeModal('equipmentDetailModal'); openModal('equipmentModal')">Volver</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Mec√°nico</th>
                            <th>Tipo</th>
                            <th>Estado</th>
                            <th>Tiempo</th>
                            <th>Descripci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="equipmentDetailTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL: RESUMEN SOLICITUDES REPUESTOS -->
    <div class="modal" id="partsRequestsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì¶ Resumen de Solicitudes de Repuestos</h2>
                <button class="btn-close" onclick="closeModal('partsRequestsModal')">√ó</button>
            </div>
            <div class="summary-stats" id="partsRequestsStats"></div>
            <div class="filters">
                <div class="filter-group">
                    <label>Filtrar por Prioridad</label>
                    <select id="partsFilterPriority" onchange="filterPartsRequests()">
                        <option value="">Todas</option>
                        <option value="Alta">Alta</option>
                        <option value="Media">Media</option>
                        <option value="Baja">Baja</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Filtrar por Equipo</label>
                    <select id="partsFilterEquipment" onchange="filterPartsRequests()">
                        <option value="">Todos</option>
                    </select>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Solicitante</th>
                            <th>Equipo</th>
                            <th>Repuesto</th>
                            <th>Cantidad</th>
                            <th>Prioridad</th>
                            <th>Motivo</th>
                        </tr>
                    </thead>
                    <tbody id="partsRequestsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL: GESTI√ìN DE EQUIPOS (ADMIN) -->
    <div class="modal" id="manageEquipmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üè≠ Gesti√≥n de Equipos</h2>
                <button class="btn-close" onclick="closeModal('manageEquipmentModal')">√ó</button>
            </div>
            
            <div class="add-item-form">
                <input type="text" id="newEquipmentName" placeholder="Nombre del nuevo equipo...">
                <button class="btn-success" onclick="addEquipment()">‚ûï Agregar</button>
            </div>

            <div class="items-list" id="equipmentManageList"></div>

            <div class="action-buttons">
                <button class="btn-secondary" onclick="closeModal('manageEquipmentModal')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- MODAL: GESTI√ìN DE CAT√ÅLOGO DE REPUESTOS (ADMIN) -->
    <div class="modal" id="managePartsListModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìã Cat√°logo de Repuestos</h2>
                <button class="btn-close" onclick="closeModal('managePartsListModal')">√ó</button>
            </div>
            
            <div class="add-item-form">
                <input type="text" id="newPartName" placeholder="Nombre/c√≥digo del repuesto...">
                <button class="btn-success" onclick="addPartToList()">‚ûï Agregar</button>
            </div>

            <div class="items-list" id="partsManageList"></div>

            <div class="action-buttons">
                <button class="btn-secondary" onclick="closeModal('managePartsListModal')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- MODAL: GESTI√ìN DE TIPOS DE MANTENIMIENTO (ADMIN) -->
    <div class="modal" id="manageTypesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîß Tipos de Mantenimiento</h2>
                <button class="btn-close" onclick="closeModal('manageTypesModal')">√ó</button>
            </div>
            
            <div class="add-item-form">
                <input type="text" id="newTypeName" placeholder="Nombre del tipo de mantenimiento...">
                <button class="btn-success" onclick="addMaintenanceType()">‚ûï Agregar</button>
            </div>

            <div class="items-list" id="typesManageList"></div>

            <div class="action-buttons">
                <button class="btn-secondary" onclick="closeModal('manageTypesModal')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- MODAL: ACCESO A ARCHIVOS EXCEL -->
    <div class="modal" id="excelAccessModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìä Archivos Excel</h2>
                <button class="btn-close" onclick="closeModal('excelAccessModal')">√ó</button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <p style="color: #666; line-height: 1.6;">
                    Los archivos Excel se generan autom√°ticamente cada vez que guardas un informe o solicitas un repuesto.
                    Aqu√≠ puedes descargar los archivos completos con todo el historial.
                </p>
            </div>

            <div style="display: grid; gap: 20px;">
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #667eea;">
                    <h3 style="color: #667eea; margin-bottom: 10px;">üìù Operaciones de Mantenimiento</h3>
                    <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                        Archivo completo con todas las operaciones realizadas incluyendo: fecha, mec√°nico, equipo, tipo, estado, tiempos, descripciones, resultados, recambios y recomendaciones.
                    </p>
                    <button class="btn-primary" onclick="downloadOperationsExcel()">
                        üì• Descargar Operaciones_Mantenimiento.xlsx
                    </button>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #28a745;">
                    <h3 style="color: #28a745; margin-bottom: 10px;">üõ†Ô∏è Solicitudes de Repuestos</h3>
                    <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                        Archivo completo con todas las solicitudes de repuestos incluyendo: fecha, solicitante, equipo, descripci√≥n, cantidad, unidad, prioridad y motivo.
                    </p>
                    <button class="btn-success" onclick="downloadPartsRequestsExcel()">
                        üì• Descargar Solicitudes_Repuestos.xlsx
                    </button>
                </div>
            </div>

            <div class="action-buttons" style="margin-top: 20px;">
                <button class="btn-secondary" onclick="closeModal('excelAccessModal')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- MODAL: GR√ÅFICA DE TAREAS POR EQUIPOS -->
    <div class="modal" id="chartModal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header">
                <h2>üìà Resumen Hist√≥rico de Tareas por Equipos</h2>
                <button class="btn-close" onclick="closeModal('chartModal')">√ó</button>
            </div>

            <div style="margin-bottom: 20px;">
                <p style="color: #666; line-height: 1.6;">
                    Visualizaci√≥n del hist√≥rico completo de todas las tareas realizadas en cada equipo.
                    Solo se muestran las operaciones que tienen un equipo asignado.
                </p>
            </div>

            <!-- Estad√≠sticas Generales -->
            <div class="summary-stats" id="chartStats"></div>

            <!-- Selector de tipo de gr√°fica -->
            <div class="filters" style="margin-bottom: 20px;">
                <div class="filter-group">
                    <label>Tipo de Gr√°fica</label>
                    <select id="chartTypeSelect" onchange="updateChart()">
                        <option value="bar">Barras</option>
                        <option value="pie">Pastel</option>
                        <option value="doughnut">Dona</option>
                        <option value="line">L√≠nea</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Ver por</label>
                    <select id="chartViewSelect" onchange="updateChart()">
                        <option value="count">Cantidad de Tareas</option>
                        <option value="time">Tiempo Total (horas)</option>
                        <option value="status">Estado (Resuelto/No Resuelto)</option>
                    </select>
                </div>
            </div>

            <!-- Canvas para la gr√°fica -->
            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <canvas id="equipmentChart" style="max-height: 500px;"></canvas>
            </div>

            <!-- Tabla de datos -->
            <div class="table-container" style="margin-top: 30px;">
                <h3 style="color: #667eea; margin-bottom: 15px;">üìã Detalle por Equipo</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Equipo</th>
                            <th>Total Tareas</th>
                            <th>Resueltas</th>
                            <th>En Progreso</th>
                            <th>No Resueltas</th>
                            <th>Tiempo Total</th>
                        </tr>
                    </thead>
                    <tbody id="chartTableBody"></tbody>
                </table>
            </div>

            <div class="action-buttons" style="margin-top: 20px;">
                <button class="btn-success" onclick="exportChartData()">üìä Exportar Datos a Excel</button>
                <button class="btn-secondary" onclick="closeModal('chartModal')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- MODAL: ROBERT - ASISTENTE IA -->
    <div class="modal" id="robertModal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header">
                <h2>ü§ñ Robert - Asistente Inteligente de Mantenimiento</h2>
                <button class="btn-close" onclick="closeModal('robertModal')">√ó</button>
            </div>

            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; color: white; margin-bottom: 25px;">
                <h3 style="margin-bottom: 10px;">üëã ¬°Hola! Soy Robert</h3>
                <p style="opacity: 0.95; line-height: 1.6;">
                    Analizo todo el hist√≥rico de mantenimiento para ayudarte a tomar mejores decisiones. 
                    Puedo sugerirte repuestos bas√°ndome en intervenciones exitosas anteriores, generar informes semanales 
                    autom√°ticos y predecir cu√°ndo necesitar√°s intervenir en cada equipo.
                </p>
            </div>

            <!-- Tabs de Robert -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0;">
                <button class="robert-tab active" onclick="switchRobertTab('suggestions')" id="tab-suggestions">
                    üîß Sugerencias de Repuestos
                </button>
                <button class="robert-tab" onclick="switchRobertTab('weekly')" id="tab-weekly">
                    üìã Informe Semanal
                </button>
                <button class="robert-tab" onclick="switchRobertTab('predictions')" id="tab-predictions">
                    üîÆ Predicci√≥n de Mantenimientos
                </button>
            </div>

            <!-- Tab 1: Sugerencias de Repuestos -->
            <div id="robert-suggestions" class="robert-tab-content active">
                <h3 style="color: #667eea; margin-bottom: 15px;">üîß Sugerencias Inteligentes de Repuestos</h3>
                <p style="color: #666; margin-bottom: 20px;">
                    Selecciona un equipo y un tipo de operaci√≥n para que analice el hist√≥rico de tareas resueltas exitosamente 
                    y te sugiera los repuestos m√°s utilizados.
                </p>

                <div class="filters">
                    <div class="filter-group">
                        <label>Seleccionar Equipo</label>
                        <select id="robertEquipmentSelect">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Tipo de Mantenimiento</label>
                        <select id="robertTypeSelect">
                            <option value="">Todos los tipos</option>
                        </select>
                    </div>
                    <div class="filter-group" style="display: flex; align-items: flex-end;">
                        <button class="btn-primary" onclick="generatePartsSuggestions()">ü§ñ Generar Sugerencias</button>
                    </div>
                </div>

                <div id="partsSuggestionsResult" style="margin-top: 20px;"></div>
            </div>

            <!-- Tab 2: Informe Semanal -->
            <div id="robert-weekly" class="robert-tab-content">
                <h3 style="color: #667eea; margin-bottom: 15px;">üìã Informe Semanal Automatizado</h3>
                <p style="color: #666; margin-bottom: 20px;">
                    Genera un informe completo de la semana con an√°lisis, estad√≠sticas y recomendaciones basadas en el hist√≥rico.
                </p>

                <div class="action-buttons" style="margin-bottom: 20px;">
                    <button class="btn-primary" onclick="generateWeeklyReport()">ü§ñ Generar Informe de la Semana</button>
                    <button class="btn-success" onclick="exportWeeklyReport()">üì• Exportar a Excel</button>
                </div>

                <div id="weeklyReportResult"></div>
            </div>

            <!-- Tab 3: Predicci√≥n de Mantenimientos -->
            <div id="robert-predictions" class="robert-tab-content">
                <h3 style="color: #667eea; margin-bottom: 15px;">üîÆ Predicci√≥n de Pr√≥ximos Mantenimientos</h3>
                <p style="color: #666; margin-bottom: 20px;">
                    Bas√°ndome en el hist√≥rico de intervenciones, predigo cu√°ndo cada equipo necesitar√° mantenimiento.
                </p>

                <div class="action-buttons" style="margin-bottom: 20px;">
                    <button class="btn-primary" onclick="generatePredictions()">ü§ñ Generar Predicciones</button>
                    <button class="btn-success" onclick="exportPredictions()">üì• Exportar a Excel</button>
                </div>

                <div id="predictionsResult"></div>
            </div>

            <div class="action-buttons" style="margin-top: 20px;">
                <button class="btn-secondary" onclick="closeModal('robertModal')">Cerrar</button>
            </div>
        </div>
    </div>

    <style>
        .robert-tab {
            padding: 12px 20px;
            background: #f8f9fa;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .robert-tab:hover {
            background: #e9ecef;
        }

        .robert-tab.active {
            background: white;
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .robert-tab-content {
            display: none;
        }

        .robert-tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .suggestion-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .suggestion-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .parts-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .part-badge-lg {
            background: #667eea;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .prediction-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #ffc107;
        }

        .prediction-urgent {
            border-left-color: #dc3545;
        }

        .prediction-soon {
            border-left-color: #ffc107;
        }

        .prediction-ok {
            border-left-color: #28a745;
        }

        .alert-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .alert-urgent {
            background: #f8d7da;
            color: #721c24;
        }

        .alert-soon {
            background: #fff3cd;
            color: #856404;
        }

        .alert-ok {
            background: #d4edda;
            color: #155724;
        }
    </style>

    <script>
        // ==========================================
        // CONFIGURACION DE FIREBASE
        // ==========================================
        // INSTRUCCIONES:
        // 1. Ve a Firebase Console y copia tu configuracion
        // 2. Reemplaza SOLO los valores entre comillas
        // 3. NO borres las comillas ni las comas
        // ==========================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyAcNgj86Q_71yc9tem_2_pZaAcas4dRvMo",
            authDomain: "mantenimiento-ccc15.firebaseapp.com",
            databaseURL: "https://mantenimiento-ccc15-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "mantenimiento-ccc15",
            storageBucket: "mantenimiento-ccc15.firebasestorage.app",
            messagingSenderId: "3681573951103",
            appId: "1:3681573951103:web:82c94d0074f6540ff3faaa"
        };

        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
        } catch (error) {
            console.warn('Firebase no configurado, usando localStorage:', error);
            db = null;
        }

        // ==========================================
        // GLOBAL VARIABLES
        // ==========================================
        let currentUser = null;
        let allReports = [];
        let allPartsRequests = [];
        let currentEquipment = null;
        let equipmentList = [];
        let partsList = [];
        let maintenanceTypesList = [];
        let selectedParts = [];
        let equipmentChart = null;

        // ==========================================
        // AUTHENTICATION
        // ==========================================
        const users = {
            'admin1': { password: 'admin123', role: 'admin', name: 'Admin 1' },
            'admin2': { password: 'admin123', role: 'admin', name: 'Admin 2' },
            'admin3': { password: 'admin123', role: 'admin', name: 'Admin 3' },
            'admin4': { password: 'admin123', role: 'admin', name: 'Admin 4' },
            'admin5': { password: 'admin123', role: 'admin', name: 'Admin 5' },
            'mec1': { password: 'mec123', role: 'mecanico', name: 'Mec√°nico 1' },
            'mec2': { password: 'mec123', role: 'mecanico', name: 'Mec√°nico 2' },
            'mec3': { password: 'mec123', role: 'mecanico', name: 'Mec√°nico 3' },
            'mec4': { password: 'mec123', role: 'mecanico', name: 'Mec√°nico 4' },
            'mec5': { password: 'mec123', role: 'mecanico', name: 'Mec√°nico 5' },
            'mec6': { password: 'mec123', role: 'mecanico', name: 'Mec√°nico 6' },
            'mec7': { password: 'mec123', role: 'mecanico', name: 'Mec√°nico 7' },
            'mec8': { password: 'mec123', role: 'mecanico', name: 'Mec√°nico 8' },
            'mec9': { password: 'mec123', role: 'mecanico', name: 'Mec√°nico 9' },
            'mec10': { password: 'mec123', role: 'mecanico', name: 'Mec√°nico 10' },
            'mec11': { password: 'mec123', role: 'mecanico', name: 'Mec√°nico 11' },
            'mec12': { password: 'mec123', role: 'mecanico', name: 'Mec√°nico 12' },
            'mec13': { password: 'mec123', role: 'mecanico', name: 'Mec√°nico 13' },
            'mec14': { password: 'mec123', role: 'mecanico', name: 'Mec√°nico 14' },
            'mec15': { password: 'mec123', role: 'mecanico', name: 'Mec√°nico 15' },
            'mec16': { password: 'mec123', role: 'mecanico', name: 'Mec√°nico 16' },
            'mec17': { password: 'mec123', role: 'mecanico', name: 'Mec√°nico 17' },
            'mec18': { password: 'mec123', role: 'mecanico', name: 'Mec√°nico 18' },
            'mec19': { password: 'mec123', role: 'mecanico', name: 'Mec√°nico 19' },
            'mec20': { password: 'mec123', role: 'mecanico', name: 'Mec√°nico 20' }
        };

        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            if (users[username] && users[username].password === password) {
                currentUser = { username: username, ...users[username] };
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                document.getElementById('userBadge').textContent = `${currentUser.name} (${currentUser.role.toUpperCase()})`;
                
                if (currentUser.role === 'admin') {
                    document.getElementById('adminEquipmentCard').style.display = 'block';
                    document.getElementById('adminPartsCard').style.display = 'block';
                    document.getElementById('adminTypesCard').style.display = 'block';
                }
                
                loadData();
            } else {
                alert('Usuario o contrase√±a incorrectos');
            }
        });

        function logout() {
            currentUser = null;
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('loginForm').reset();
            document.getElementById('adminEquipmentCard').style.display = 'none';
            document.getElementById('adminPartsCard').style.display = 'none';
            document.getElementById('adminTypesCard').style.display = 'none';
        }

        // ==========================================
        // DATA MANAGEMENT
        // ==========================================
        function loadData() {
            if (db) {
                db.ref('reports').on('value', (snapshot) => {
                    allReports = [];
                    snapshot.forEach((child) => {
                        allReports.push({ id: child.key, ...child.val() });
                    });
                    allReports.sort((a, b) => new Date(b.date) - new Date(a.date));
                });

                db.ref('partsRequests').on('value', (snapshot) => {
                    allPartsRequests = [];
                    snapshot.forEach((child) => {
                        allPartsRequests.push({ id: child.key, ...child.val() });
                    });
                    allPartsRequests.sort((a, b) => new Date(b.date) - new Date(a.date));
                });

                db.ref('equipmentList').on('value', (snapshot) => {
                    equipmentList = snapshot.val() || getDefaultEquipmentList();
                    updateEquipmentDropdowns();
                });

                db.ref('partsList').on('value', (snapshot) => {
                    partsList = snapshot.val() || getDefaultPartsList();
                    updatePartsDropdowns();
                });

                db.ref('maintenanceTypesList').on('value', (snapshot) => {
                    maintenanceTypesList = snapshot.val() || getDefaultMaintenanceTypes();
                    updateMaintenanceTypesDropdowns();
                });
            } else {
                allReports = JSON.parse(localStorage.getItem('reports') || '[]');
                allPartsRequests = JSON.parse(localStorage.getItem('partsRequests') || '[]');
                equipmentList = JSON.parse(localStorage.getItem('equipmentList') || 'null') || getDefaultEquipmentList();
                partsList = JSON.parse(localStorage.getItem('partsList') || 'null') || getDefaultPartsList();
                maintenanceTypesList = JSON.parse(localStorage.getItem('maintenanceTypesList') || 'null') || getDefaultMaintenanceTypes();
                updateEquipmentDropdowns();
                updatePartsDropdowns();
                updateMaintenanceTypesDropdowns();
            }
        }

        function saveData() {
            if (!db) {
                localStorage.setItem('reports', JSON.stringify(allReports));
                localStorage.setItem('partsRequests', JSON.stringify(allPartsRequests));
                localStorage.setItem('equipmentList', JSON.stringify(equipmentList));
                localStorage.setItem('partsList', JSON.stringify(partsList));
                localStorage.setItem('maintenanceTypesList', JSON.stringify(maintenanceTypesList));
            }
        }

        function getDefaultEquipmentList() {
            return [
                'Bomba 1', 'Bomba 2', 'Compresor A', 'Compresor B',
                'Motor 1', 'Motor 2', 'Caldera', 'Sistema HVAC',
                'Elevador 1', 'Elevador 2', 'General'
            ];
        }

        function getDefaultPartsList() {
            return [
                'Rodamiento 6205', 'Correa A-47', 'Filtro de aire',
                'Aceite hidr√°ulico ISO 68', 'Junta de culata',
                'Bobina de solenoide', 'Fusible 20A', 'Rel√© t√©rmico',
                'V√°lvula check 1"', 'Manguera hidr√°ulica 3/4"'
            ];
        }

        function getDefaultMaintenanceTypes() {
            return [
                'Preventivo', 'Correctivo', 'Predictivo', 
                'Inspecci√≥n', 'Emergencia'
            ];
        }

        // ==========================================
        // MAINTENANCE TYPES MANAGEMENT
        // ==========================================
        function updateMaintenanceTypesDropdowns() {
            const selects = [
                document.getElementById('reportType'),
                document.getElementById('weeklyFilterType')
            ];

            selects.forEach(select => {
                if (!select) return;
                const currentValue = select.value;
                const defaultOption = select.id === 'weeklyFilterType' ? 
                    '<option value="">Todos</option>' : 
                    '<option value="">Seleccionar...</option>';
                    
                select.innerHTML = defaultOption +
                    maintenanceTypesList.map(type => `<option value="${type}">${type}</option>`).join('');
                select.value = currentValue;
            });

            if (currentUser && currentUser.role === 'admin') {
                renderMaintenanceTypesManageList();
            }
        }

        function renderMaintenanceTypesManageList() {
            const list = document.getElementById('typesManageList');
            if (!list) return;
            list.innerHTML = maintenanceTypesList.map((type, index) => `
                <div class="item-entry">
                    <span class="item-name">${type}</span>
                    <button class="btn-danger" onclick="removeMaintenanceType(${index})">üóëÔ∏è Eliminar</button>
                </div>
            `).join('');
        }

        async function addMaintenanceType() {
            const input = document.getElementById('newTypeName');
            const name = input.value.trim();
            
            if (!name) {
                alert('Por favor ingresa un nombre para el tipo de mantenimiento');
                return;
            }

            if (maintenanceTypesList.includes(name)) {
                alert('Este tipo de mantenimiento ya existe en la lista');
                return;
            }

            maintenanceTypesList.push(name);
            
            if (db) {
                await db.ref('maintenanceTypesList').set(maintenanceTypesList);
            } else {
                saveData();
            }

            input.value = '';
            updateMaintenanceTypesDropdowns();
            showNotification('‚úÖ Tipo de mantenimiento agregado exitosamente');
        }

        async function removeMaintenanceType(index) {
            if (!confirm('¬øEst√°s seguro de eliminar este tipo de mantenimiento?')) return;

            maintenanceTypesList.splice(index, 1);
            
            if (db) {
                await db.ref('maintenanceTypesList').set(maintenanceTypesList);
            } else {
                saveData();
            }

            updateMaintenanceTypesDropdowns();
            showNotification('‚úÖ Tipo de mantenimiento eliminado exitosamente');
        }

        // ==========================================
        // EXCEL DOWNLOAD FUNCTIONS
        // ==========================================
        function downloadOperationsExcel() {
            autoExportReports();
            showNotification('‚úÖ Archivo de operaciones descargado');
        }

        function downloadPartsRequestsExcel() {
            autoExportPartsRequests();
            showNotification('‚úÖ Archivo de solicitudes descargado');
        }

        // ==========================================
        // CHART FUNCTIONS
        // ==========================================
        function loadEquipmentChart() {
            // Filtrar solo reportes con equipos
            const reportsWithEquipment = allReports.filter(r => r.equipment && r.equipment.trim() !== '');
            
            // Agrupar por equipo
            const equipmentData = {};
            reportsWithEquipment.forEach(r => {
                if (!equipmentData[r.equipment]) {
                    equipmentData[r.equipment] = {
                        name: r.equipment,
                        total: 0,
                        resuelto: 0,
                        enProgreso: 0,
                        noResuelto: 0,
                        totalTime: 0
                    };
                }
                equipmentData[r.equipment].total++;
                if (r.status === 'Resuelto') equipmentData[r.equipment].resuelto++;
                if (r.status === 'En Progreso') equipmentData[r.equipment].enProgreso++;
                if (r.status === 'No Resuelto') equipmentData[r.equipment].noResuelto++;
                equipmentData[r.equipment].totalTime += parseInt(r.totalTime || 0);
            });

            // Ordenar por cantidad de tareas
            const sortedData = Object.values(equipmentData).sort((a, b) => b.total - a.total);

            // Estad√≠sticas generales
            const totalTasks = reportsWithEquipment.length;
            const totalResuelto = reportsWithEquipment.filter(r => r.status === 'Resuelto').length;
            const totalTime = reportsWithEquipment.reduce((sum, r) => sum + parseInt(r.totalTime || 0), 0);
            const equipmentCount = sortedData.length;

            document.getElementById('chartStats').innerHTML = `
                <div class="stat-box">
                    <div class="stat-number">${totalTasks}</div>
                    <div class="stat-label">Total Tareas</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${equipmentCount}</div>
                    <div class="stat-label">Equipos</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${totalResuelto}</div>
                    <div class="stat-label">Resueltas</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${Math.round(totalTime / 60)}h</div>
                    <div class="stat-label">Tiempo Total</div>
                </div>
            `;

            // Tabla de datos
            const tbody = document.getElementById('chartTableBody');
            tbody.innerHTML = sortedData.map(eq => `
                <tr>
                    <td><strong>${eq.name}</strong></td>
                    <td>${eq.total}</td>
                    <td>${eq.resuelto}</td>
                    <td>${eq.enProgreso}</td>
                    <td>${eq.noResuelto}</td>
                    <td>${Math.round(eq.totalTime / 60)}h ${eq.totalTime % 60}m</td>
                </tr>
            `).join('');

            // Crear gr√°fica
            updateChart();
        }

        function updateChart() {
            const chartType = document.getElementById('chartTypeSelect').value;
            const viewType = document.getElementById('chartViewSelect').value;

            // Filtrar solo reportes con equipos
            const reportsWithEquipment = allReports.filter(r => r.equipment && r.equipment.trim() !== '');
            
            // Agrupar por equipo
            const equipmentData = {};
            reportsWithEquipment.forEach(r => {
                if (!equipmentData[r.equipment]) {
                    equipmentData[r.equipment] = {
                        name: r.equipment,
                        total: 0,
                        resuelto: 0,
                        noResuelto: 0,
                        totalTime: 0
                    };
                }
                equipmentData[r.equipment].total++;
                if (r.status === 'Resuelto') equipmentData[r.equipment].resuelto++;
                if (r.status === 'No Resuelto') equipmentData[r.equipment].noResuelto++;
                equipmentData[r.equipment].totalTime += parseInt(r.totalTime || 0);
            });

            // Ordenar por cantidad de tareas
            const sortedData = Object.values(equipmentData).sort((a, b) => b.total - a.total);

            const labels = sortedData.map(eq => eq.name);
            let data, label;

            if (viewType === 'count') {
                data = sortedData.map(eq => eq.total);
                label = 'Cantidad de Tareas';
            } else if (viewType === 'time') {
                data = sortedData.map(eq => (eq.totalTime / 60).toFixed(1));
                label = 'Tiempo Total (horas)';
            } else { // status
                // Para el caso de estado, mostrar resueltas vs no resueltas
                const ctx = document.getElementById('equipmentChart').getContext('2d');
                
                if (equipmentChart) {
                    equipmentChart.destroy();
                }

                equipmentChart = new Chart(ctx, {
                    type: chartType,
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Resueltas',
                                data: sortedData.map(eq => eq.resuelto),
                                backgroundColor: 'rgba(75, 192, 192, 0.7)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 2
                            },
                            {
                                label: 'No Resueltas',
                                data: sortedData.map(eq => eq.noResuelto),
                                backgroundColor: 'rgba(255, 99, 132, 0.7)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            title: {
                                display: true,
                                text: 'Tareas por Estado',
                                font: { size: 16 }
                            }
                        },
                        scales: chartType === 'bar' || chartType === 'line' ? {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                            }
                        } : {}
                    }
                });
                return;
            }

            const ctx = document.getElementById('equipmentChart').getContext('2d');
            
            if (equipmentChart) {
                equipmentChart.destroy();
            }

            // Colores vibrantes para las barras
            const colors = [
                'rgba(102, 126, 234, 0.7)',
                'rgba(118, 75, 162, 0.7)',
                'rgba(237, 100, 166, 0.7)',
                'rgba(255, 154, 158, 0.7)',
                'rgba(250, 208, 196, 0.7)',
                'rgba(155, 93, 229, 0.7)',
                'rgba(132, 94, 194, 0.7)',
                'rgba(72, 219, 251, 0.7)',
                'rgba(29, 233, 182, 0.7)',
                'rgba(252, 196, 25, 0.7)'
            ];

            const backgroundColors = sortedData.map((_, i) => colors[i % colors.length]);
            const borderColors = backgroundColors.map(color => color.replace('0.7', '1'));

            equipmentChart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: chartType === 'pie' || chartType === 'doughnut',
                            position: 'right'
                        },
                        title: {
                            display: true,
                            text: label + ' por Equipo',
                            font: { size: 16 }
                        }
                    },
                    scales: chartType === 'bar' || chartType === 'line' ? {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: viewType === 'count' ? 1 : undefined }
                        }
                    } : {}
                }
            });
        }

        function exportChartData() {
            const reportsWithEquipment = allReports.filter(r => r.equipment && r.equipment.trim() !== '');
            
            const equipmentData = {};
            reportsWithEquipment.forEach(r => {
                if (!equipmentData[r.equipment]) {
                    equipmentData[r.equipment] = {
                        total: 0,
                        resuelto: 0,
                        enProgreso: 0,
                        noResuelto: 0,
                        totalTime: 0
                    };
                }
                equipmentData[r.equipment].total++;
                if (r.status === 'Resuelto') equipmentData[r.equipment].resuelto++;
                if (r.status === 'En Progreso') equipmentData[r.equipment].enProgreso++;
                if (r.status === 'No Resuelto') equipmentData[r.equipment].noResuelto++;
                equipmentData[r.equipment].totalTime += parseInt(r.totalTime || 0);
            });

            const sortedData = Object.values(equipmentData).sort((a, b) => b.total - a.total);

            const ws = XLSX.utils.json_to_sheet(sortedData.map(eq => ({
                'Equipo': eq.name,
                'Total Tareas': eq.total,
                'Resueltas': eq.resuelto,
                'En Progreso': eq.enProgreso,
                'No Resueltas': eq.noResuelto,
                'Tiempo Total (min)': eq.totalTime,
                'Tiempo Total (horas)': (eq.totalTime / 60).toFixed(2)
            })));

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Resumen por Equipos');
            
            const fecha = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `Resumen_Tareas_Equipos_${fecha}.xlsx`);
            
            showNotification('‚úÖ Datos de la gr√°fica exportados a Excel');
        }

        // ==========================================
        // ROBERT AI FUNCTIONS
        // ==========================================
        let weeklyReportData = null;
        let predictionsData = null;

        function switchRobertTab(tabName) {
            // Ocultar todos los tabs
            document.querySelectorAll('.robert-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.robert-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostrar el tab seleccionado
            document.getElementById('robert-' + tabName).classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        function loadRobertModal() {
            // Poblar selectores
            const equipmentSelect = document.getElementById('robertEquipmentSelect');
            equipmentSelect.innerHTML = '<option value="">Seleccionar...</option>' +
                equipmentList.map(eq => `<option value="${eq}">${eq}</option>`).join('');

            const typeSelect = document.getElementById('robertTypeSelect');
            typeSelect.innerHTML = '<option value="">Todos los tipos</option>' +
                maintenanceTypesList.map(type => `<option value="${type}">${type}</option>`).join('');
        }

        function generatePartsSuggestions() {
            const equipment = document.getElementById('robertEquipmentSelect').value;
            const type = document.getElementById('robertTypeSelect').value;

            if (!equipment) {
                alert('Por favor selecciona un equipo');
                return;
            }

            // Filtrar tareas resueltas del equipo seleccionado
            let filteredReports = allReports.filter(r => 
                r.equipment === equipment && 
                r.status === 'Resuelto' &&
                r.parts && r.parts.trim() !== ''
            );

            if (type) {
                filteredReports = filteredReports.filter(r => r.type === type);
            }

            if (filteredReports.length === 0) {
                document.getElementById('partsSuggestionsResult').innerHTML = `
                    <div class="suggestion-card" style="border-left-color: #ffc107;">
                        <h4>‚ö†Ô∏è Sin datos suficientes</h4>
                        <p style="color: #666;">No hay tareas resueltas exitosamente en este equipo${type ? ' para este tipo de mantenimiento' : ''} que incluyan repuestos.</p>
                    </div>
                `;
                return;
            }

            // Analizar repuestos m√°s utilizados
            const partsCount = {};
            filteredReports.forEach(r => {
                const parts = r.parts.split(',').map(p => p.trim()).filter(p => p);
                parts.forEach(part => {
                    partsCount[part] = (partsCount[part] || 0) + 1;
                });
            });

            // Ordenar por frecuencia
            const sortedParts = Object.entries(partsCount)
                .sort((a, b) => b[1] - a[1])
                .map(([part, count]) => ({ part, count, percentage: (count / filteredReports.length * 100).toFixed(0) }));

            // Calcular tiempo promedio
            const avgTime = filteredReports.reduce((sum, r) => sum + parseInt(r.totalTime || 0), 0) / filteredReports.length;

            // Mostrar resultados
            document.getElementById('partsSuggestionsResult').innerHTML = `
                <div class="suggestion-card">
                    <h4>üéØ An√°lisis Completado</h4>
                    <p style="color: #666; margin-bottom: 15px;">
                        Analic√© <strong>${filteredReports.length} tareas resueltas</strong> en <strong>${equipment}</strong>
                        ${type ? `(${type})` : ''} y encontr√© los siguientes repuestos m√°s utilizados:
                    </p>
                    <div class="summary-stats" style="margin-bottom: 15px;">
                        <div class="stat-box">
                            <div class="stat-number">${filteredReports.length}</div>
                            <div class="stat-label">Tareas Analizadas</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number">${sortedParts.length}</div>
                            <div class="stat-label">Repuestos √önicos</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number">${Math.round(avgTime)} min</div>
                            <div class="stat-label">Tiempo Promedio</div>
                        </div>
                    </div>
                </div>

                <div class="suggestion-card">
                    <h4>üîß Repuestos Recomendados (ordenados por frecuencia)</h4>
                    ${sortedParts.slice(0, 10).map((item, index) => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 8px; margin-top: 10px;">
                            <div>
                                <strong style="color: #667eea;">${index + 1}. ${item.part}</strong>
                            </div>
                            <div style="text-align: right;">
                                <span class="badge badge-resuelto">${item.count} veces (${item.percentage}%)</span>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="suggestion-card" style="border-left-color: #28a745;">
                    <h4>üí° Recomendaci√≥n de Robert</h4>
                    <p style="color: #666;">
                        Para intervenciones en <strong>${equipment}</strong>, te sugiero tener disponibles los 
                        <strong>${Math.min(3, sortedParts.length)} repuestos principales</strong> antes de comenzar:
                    </p>
                    <div class="parts-badges">
                        ${sortedParts.slice(0, 3).map(item => `
                            <span class="part-badge-lg">${item.part}</span>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function generateWeeklyReport() {
            const today = new Date();
            const lastMonday = new Date(today);
            lastMonday.setDate(today.getDate() - today.getDay() - 6);
            const lastSunday = new Date(lastMonday);
            lastSunday.setDate(lastMonday.getDate() + 6);

            const weeklyReports = allReports.filter(r => {
                const reportDate = new Date(r.date);
                return reportDate >= lastMonday && reportDate <= lastSunday;
            });

            const weeklyParts = allPartsRequests.filter(p => {
                const requestDate = new Date(p.date);
                return requestDate >= lastMonday && requestDate <= lastSunday;
            });

            // An√°lisis por equipo
            const equipmentAnalysis = {};
            weeklyReports.forEach(r => {
                if (r.equipment) {
                    if (!equipmentAnalysis[r.equipment]) {
                        equipmentAnalysis[r.equipment] = {
                            total: 0,
                            resuelto: 0,
                            enProgreso: 0,
                            noResuelto: 0,
                            totalTime: 0
                        };
                    }
                    equipmentAnalysis[r.equipment].total++;
                    if (r.status === 'Resuelto') equipmentAnalysis[r.equipment].resuelto++;
                    if (r.status === 'En Progreso') equipmentAnalysis[r.equipment].enProgreso++;
                    if (r.status === 'No Resuelto') equipmentAnalysis[r.equipment].noResuelto++;
                    equipmentAnalysis[r.equipment].totalTime += parseInt(r.totalTime || 0);
                }
            });

            // An√°lisis por tipo
            const typeAnalysis = {};
            weeklyReports.forEach(r => {
                typeAnalysis[r.type] = (typeAnalysis[r.type] || 0) + 1;
            });

            // An√°lisis por mec√°nico
            const mechanicAnalysis = {};
            weeklyReports.forEach(r => {
                if (!mechanicAnalysis[r.mechanic]) {
                    mechanicAnalysis[r.mechanic] = { total: 0, resuelto: 0 };
                }
                mechanicAnalysis[r.mechanic].total++;
                if (r.status === 'Resuelto') mechanicAnalysis[r.mechanic].resuelto++;
            });

            const totalTime = weeklyReports.reduce((sum, r) => sum + parseInt(r.totalTime || 0), 0);
            const resueltoCount = weeklyReports.filter(r => r.status === 'Resuelto').length;
            const efectividad = weeklyReports.length > 0 ? ((resueltoCount / weeklyReports.length) * 100).toFixed(1) : 0;

            // Identificar equipos problem√°ticos
            const problematicEquipment = Object.entries(equipmentAnalysis)
                .filter(([_, data]) => data.noResuelto > 0 || data.enProgreso > 1)
                .sort((a, b) => (b[1].noResuelto + b[1].enProgreso) - (a[1].noResuelto + a[1].enProgreso));

            // Guardar datos para exportaci√≥n
            weeklyReportData = {
                period: `${lastMonday.toLocaleDateString('es-ES')} - ${lastSunday.toLocaleDateString('es-ES')}`,
                weeklyReports,
                weeklyParts,
                equipmentAnalysis,
                typeAnalysis,
                mechanicAnalysis,
                stats: {
                    total: weeklyReports.length,
                    resuelto: resueltoCount,
                    efectividad,
                    totalTime
                }
            };

            document.getElementById('weeklyReportResult').innerHTML = `
                <div class="suggestion-card" style="border-left-color: #667eea;">
                    <h4>üìÖ Periodo: ${lastMonday.toLocaleDateString('es-ES')} - ${lastSunday.toLocaleDateString('es-ES')}</h4>
                    <div class="summary-stats" style="margin-top: 15px;">
                        <div class="stat-box">
                            <div class="stat-number">${weeklyReports.length}</div>
                            <div class="stat-label">Total Operaciones</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number">${resueltoCount}</div>
                            <div class="stat-label">Resueltas</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number">${efectividad}%</div>
                            <div class="stat-label">Efectividad</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number">${Math.round(totalTime / 60)}h</div>
                            <div class="stat-label">Tiempo Total</div>
                        </div>
                    </div>
                </div>

                <div class="suggestion-card">
                    <h4>üîß Resumen por Equipos</h4>
                    ${Object.entries(equipmentAnalysis).sort((a, b) => b[1].total - a[1].total).map(([eq, data]) => `
                        <div style="padding: 10px; background: white; border-radius: 8px; margin-top: 8px;">
                            <strong>${eq}:</strong> ${data.total} tareas 
                            (${data.resuelto} resueltas, ${data.enProgreso} en progreso, ${data.noResuelto} no resueltas)
                            - ${Math.round(data.totalTime / 60)}h
                        </div>
                    `).join('')}
                </div>

                <div class="suggestion-card">
                    <h4>üìä Distribuci√≥n por Tipo</h4>
                    ${Object.entries(typeAnalysis).sort((a, b) => b[1] - a[1]).map(([type, count]) => `
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 8px; margin-top: 8px;">
                            <span>${type}</span>
                            <span class="badge badge-resuelto">${count} operaciones</span>
                        </div>
                    `).join('')}
                </div>

                <div class="suggestion-card">
                    <h4>üë• Rendimiento por Mec√°nico</h4>
                    ${Object.entries(mechanicAnalysis).sort((a, b) => b[1].total - a[1].total).map(([mech, data]) => {
                        const mechEfectividad = ((data.resuelto / data.total) * 100).toFixed(0);
                        return `
                            <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 8px; margin-top: 8px;">
                                <span><strong>${mech}</strong></span>
                                <span>${data.total} tareas (${mechEfectividad}% efectividad)</span>
                            </div>
                        `;
                    }).join('')}
                </div>

                ${problematicEquipment.length > 0 ? `
                    <div class="suggestion-card" style="border-left-color: #ffc107;">
                        <h4>‚ö†Ô∏è Equipos que Requieren Atenci√≥n</h4>
                        ${problematicEquipment.map(([eq, data]) => `
                            <div style="padding: 10px; background: #fff3cd; border-radius: 8px; margin-top: 8px;">
                                <strong>${eq}:</strong> 
                                ${data.noResuelto} tareas no resueltas, 
                                ${data.enProgreso} en progreso
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                <div class="suggestion-card" style="border-left-color: #28a745;">
                    <h4>üí° Recomendaciones de Robert</h4>
                    <ul style="color: #666; line-height: 2; margin-left: 20px;">
                        <li>La efectividad de esta semana fue del <strong>${efectividad}%</strong> ${efectividad >= 80 ? '‚úÖ ¬°Excelente trabajo!' : efectividad >= 60 ? '‚ö†Ô∏è Mejorable' : '‚ùå Requiere atenci√≥n'}</li>
                        <li>Se invirtieron <strong>${Math.round(totalTime / 60)} horas</strong> en mantenimiento</li>
                        <li>Se realizaron <strong>${weeklyParts.length} solicitudes de repuestos</strong></li>
                        ${problematicEquipment.length > 0 ? `<li>‚ö†Ô∏è Priorizar atenci√≥n en: <strong>${problematicEquipment[0][0]}</strong></li>` : ''}
                        <li>${typeAnalysis['Preventivo'] || 0} mantenimientos preventivos vs ${typeAnalysis['Correctivo'] || 0} correctivos 
                        ${(typeAnalysis['Preventivo'] || 0) > (typeAnalysis['Correctivo'] || 0) ? '‚úÖ Buena proporci√≥n' : '‚ö†Ô∏è Aumentar preventivos'}</li>
                    </ul>
                </div>
            `;
        }

        function generatePredictions() {
            // Analizar frecuencia de mantenimiento por equipo
            const equipmentHistory = {};
            
            allReports.forEach(r => {
                if (r.equipment && r.equipment.trim() !== '') {
                    if (!equipmentHistory[r.equipment]) {
                        equipmentHistory[r.equipment] = [];
                    }
                    equipmentHistory[r.equipment].push(new Date(r.date));
                }
            });

            // Calcular intervalos promedio y predecir pr√≥ximo mantenimiento
            const predictions = [];
            const today = new Date();

            Object.entries(equipmentHistory).forEach(([equipment, dates]) => {
                if (dates.length < 2) return; // Necesitamos al menos 2 registros

                // Ordenar fechas
                dates.sort((a, b) => a - b);

                // Calcular intervalos en d√≠as
                const intervals = [];
                for (let i = 1; i < dates.length; i++) {
                    const diffDays = Math.round((dates[i] - dates[i-1]) / (1000 * 60 * 60 * 24));
                    intervals.push(diffDays);
                }

                // Calcular promedio de intervalo
                const avgInterval = intervals.reduce((sum, val) => sum + val, 0) / intervals.length;
                
                // √öltima intervenci√≥n
                const lastDate = dates[dates.length - 1];
                const daysSinceLast = Math.round((today - lastDate) / (1000 * 60 * 60 * 24));
                
                // Predecir pr√≥xima fecha
                const daysUntilNext = Math.round(avgInterval - daysSinceLast);
                const nextDate = new Date(today);
                nextDate.setDate(nextDate.getDate() + daysUntilNext);

                // Clasificar urgencia
                let urgency, urgencyText;
                if (daysUntilNext < 0) {
                    urgency = 'urgent';
                    urgencyText = 'üî¥ URGENTE';
                } else if (daysUntilNext <= 7) {
                    urgency = 'soon';
                    urgencyText = 'üü° PR√ìXIMAMENTE';
                } else {
                    urgency = 'ok';
                    urgencyText = 'üü¢ OK';
                }

                predictions.push({
                    equipment,
                    totalInterventions: dates.length,
                    avgInterval: Math.round(avgInterval),
                    lastDate: lastDate.toLocaleDateString('es-ES'),
                    daysSinceLast,
                    daysUntilNext,
                    nextDate: nextDate.toLocaleDateString('es-ES'),
                    urgency,
                    urgencyText
                });
            });

            // Ordenar por urgencia
            predictions.sort((a, b) => a.daysUntilNext - b.daysUntilNext);

            predictionsData = predictions;

            document.getElementById('predictionsResult').innerHTML = `
                <div class="suggestion-card">
                    <h4>üîÆ An√°lisis Predictivo Completado</h4>
                    <p style="color: #666;">
                        Bas√°ndome en el hist√≥rico de <strong>${allReports.length} operaciones</strong>, 
                        he calculado los patrones de mantenimiento de <strong>${predictions.length} equipos</strong>.
                    </p>
                </div>

                ${predictions.map(pred => `
                    <div class="prediction-card prediction-${pred.urgency}">
                        <span class="alert-badge alert-${pred.urgency}">${pred.urgencyText}</span>
                        <h4 style="color: #667eea; margin-bottom: 10px;">‚öôÔ∏è ${pred.equipment}</h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                            <div>
                                <small style="color: #666;">Intervenciones Totales</small>
                                <div style="font-weight: bold; font-size: 1.2em;">${pred.totalInterventions}</div>
                            </div>
                            <div>
                                <small style="color: #666;">Intervalo Promedio</small>
                                <div style="font-weight: bold; font-size: 1.2em;">${pred.avgInterval} d√≠as</div>
                            </div>
                            <div>
                                <small style="color: #666;">√öltima Intervenci√≥n</small>
                                <div style="font-weight: bold;">${pred.lastDate}</div>
                            </div>
                            <div>
                                <small style="color: #666;">D√≠as desde √öltima</small>
                                <div style="font-weight: bold;">${pred.daysSinceLast} d√≠as</div>
                            </div>
                        </div>

                        <div style="background: ${pred.urgency === 'urgent' ? '#f8d7da' : pred.urgency === 'soon' ? '#fff3cd' : '#d4edda'}; 
                                    padding: 15px; border-radius: 8px;">
                            <strong style="font-size: 1.1em;">
                                ${pred.daysUntilNext < 0 ? 
                                    `‚ö†Ô∏è Debi√≥ recibir mantenimiento hace ${Math.abs(pred.daysUntilNext)} d√≠as` :
                                    pred.daysUntilNext === 0 ?
                                    `‚ö†Ô∏è Necesita mantenimiento HOY` :
                                    `Pr√≥ximo mantenimiento estimado: ${pred.nextDate} (en ${pred.daysUntilNext} d√≠as)`
                                }
                            </strong>
                        </div>

                        ${pred.urgency === 'urgent' ? `
                            <div style="margin-top: 10px; color: #721c24;">
                                <strong>üí° Acci√≥n recomendada:</strong> Programar intervenci√≥n inmediata
                            </div>
                        ` : pred.urgency === 'soon' ? `
                            <div style="margin-top: 10px; color: #856404;">
                                <strong>üí° Acci√≥n recomendada:</strong> Planificar intervenci√≥n esta semana
                            </div>
                        ` : ''}
                    </div>
                `).join('')}

                <div class="suggestion-card" style="border-left-color: #28a745;">
                    <h4>üí° Resumen de Predicciones</h4>
                    <ul style="color: #666; line-height: 2; margin-left: 20px;">
                        <li><strong>${predictions.filter(p => p.urgency === 'urgent').length}</strong> equipos requieren atenci√≥n inmediata üî¥</li>
                        <li><strong>${predictions.filter(p => p.urgency === 'soon').length}</strong> equipos necesitan intervenci√≥n pr√≥ximamente üü°</li>
                        <li><strong>${predictions.filter(p => p.urgency === 'ok').length}</strong> equipos est√°n en buen estado üü¢</li>
                    </ul>
                </div>
            `;
        }

        function exportWeeklyReport() {
            if (!weeklyReportData) {
                generateWeeklyReport();
                setTimeout(exportWeeklyReport, 500);
                return;
            }

            const ws = XLSX.utils.json_to_sheet(weeklyReportData.weeklyReports.map(r => ({
                'Fecha': r.date,
                'Mec√°nico': r.mechanic,
                'Equipo': r.equipment,
                'Tipo': r.type,
                'Estado': r.status,
                'Tiempo (min)': r.totalTime,
                'Descripci√≥n': r.description,
                'Resultados': r.results,
                'Recambios': r.parts
            })));

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Operaciones');

            // Agregar hoja de estad√≠sticas
            const statsData = [
                { 'M√©trica': 'Total Operaciones', 'Valor': weeklyReportData.stats.total },
                { 'M√©trica': 'Resueltas', 'Valor': weeklyReportData.stats.resuelto },
                { 'M√©trica': 'Efectividad (%)', 'Valor': weeklyReportData.stats.efectividad },
                { 'M√©trica': 'Tiempo Total (min)', 'Valor': weeklyReportData.stats.totalTime },
                { 'M√©trica': 'Tiempo Total (horas)', 'Valor': Math.round(weeklyReportData.stats.totalTime / 60) }
            ];
            const wsStats = XLSX.utils.json_to_sheet(statsData);
            XLSX.utils.book_append_sheet(wb, wsStats, 'Estad√≠sticas');

            const fecha = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `Informe_Semanal_Robert_${fecha}.xlsx`);
            
            showNotification('‚úÖ Informe semanal exportado a Excel');
        }

        function exportPredictions() {
            if (!predictionsData) {
                generatePredictions();
                setTimeout(exportPredictions, 500);
                return;
            }

            const ws = XLSX.utils.json_to_sheet(predictionsData.map(p => ({
                'Equipo': p.equipment,
                'Total Intervenciones': p.totalInterventions,
                'Intervalo Promedio (d√≠as)': p.avgInterval,
                '√öltima Intervenci√≥n': p.lastDate,
                'D√≠as desde √öltima': p.daysSinceLast,
                'Pr√≥ximo Mantenimiento': p.nextDate,
                'D√≠as hasta Pr√≥ximo': p.daysUntilNext,
                'Urgencia': p.urgencyText
            })));

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Predicciones');

            const fecha = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `Predicciones_Mantenimiento_Robert_${fecha}.xlsx`);
            
            showNotification('‚úÖ Predicciones exportadas a Excel');
        }

        // ==========================================
        // PARTS SELECTION FOR REPORT
        // ==========================================
        function addPartToReport() {
            const select = document.getElementById('reportPartsSelect');
            const value = select.value;
            
            if (!value) {
                alert('Por favor selecciona un repuesto');
                return;
            }

            if (value === '__NUEVO__') {
                const newPart = prompt('Ingresa el nombre del nuevo repuesto:');
                if (newPart && newPart.trim()) {
                    selectedParts.push(newPart.trim());
                    renderSelectedParts();
                }
            } else {
                if (!selectedParts.includes(value)) {
                    selectedParts.push(value);
                    renderSelectedParts();
                }
            }
            
            select.value = '';
        }

        function renderSelectedParts() {
            const container = document.getElementById('reportPartsList');
            if (selectedParts.length === 0) {
                container.innerHTML = '<small style="color: #666;">Los repuestos seleccionados aparecer√°n aqu√≠</small>';
            } else {
                container.innerHTML = selectedParts.map((part, index) => `
                    <span class="part-tag">
                        ${part}
                        <span class="remove-part" onclick="removePart(${index})">√ó</span>
                    </span>
                `).join('');
            }
        }

        function removePart(index) {
            selectedParts.splice(index, 1);
            renderSelectedParts();
        }

        function openPartsRequestFromReport() {
            closeModal('reportModal');
            openModal('partsModal');
        }

        // ==========================================
        // EQUIPMENT MANAGEMENT
        // ==========================================
        function updateEquipmentDropdowns() {
            const selects = [
                document.getElementById('reportEquipment'),
                document.getElementById('partsEquipment'),
                document.getElementById('equipmentFilterSelect')
            ];

            selects.forEach(select => {
                if (!select) return;
                const currentValue = select.value;
                const defaultOption = select.id === 'equipmentFilterSelect' ? 
                    '<option value="">Todos los equipos</option>' : 
                    '<option value="">Seleccionar...</option>';
                    
                select.innerHTML = defaultOption +
                    equipmentList.map(eq => `<option value="${eq}">${eq}</option>`).join('');
                select.value = currentValue;
            });

            if (currentUser && currentUser.role === 'admin') {
                renderEquipmentManageList();
            }
        }

        function renderEquipmentManageList() {
            const list = document.getElementById('equipmentManageList');
            list.innerHTML = equipmentList.map((eq, index) => `
                <div class="item-entry">
                    <span class="item-name">${eq}</span>
                    <button class="btn-danger" onclick="removeEquipment(${index})">üóëÔ∏è Eliminar</button>
                </div>
            `).join('');
        }

        async function addEquipment() {
            const input = document.getElementById('newEquipmentName');
            const name = input.value.trim();
            
            if (!name) {
                alert('Por favor ingresa un nombre para el equipo');
                return;
            }

            if (equipmentList.includes(name)) {
                alert('Este equipo ya existe en la lista');
                return;
            }

            equipmentList.push(name);
            
            if (db) {
                await db.ref('equipmentList').set(equipmentList);
            } else {
                saveData();
            }

            input.value = '';
            updateEquipmentDropdowns();
            showNotification('‚úÖ Equipo agregado exitosamente');
        }

        async function removeEquipment(index) {
            if (!confirm('¬øEst√°s seguro de eliminar este equipo?')) return;

            equipmentList.splice(index, 1);
            
            if (db) {
                await db.ref('equipmentList').set(equipmentList);
            } else {
                saveData();
            }

            updateEquipmentDropdowns();
            showNotification('‚úÖ Equipo eliminado exitosamente');
        }

        // ==========================================
        // PARTS LIST MANAGEMENT
        // ==========================================
        function updatePartsDropdowns() {
            const selects = [
                document.getElementById('partsCatalog'),
                document.getElementById('reportPartsSelect')
            ];
            
            selects.forEach(select => {
                if (!select) return;
                const currentValue = select.value;
                const isReportSelect = select.id === 'reportPartsSelect';
                
                const defaultOption = isReportSelect ? 
                    '<option value="">Seleccionar repuesto...</option><option value="__NUEVO__">üÜï Repuesto Nuevo</option>' :
                    '<option value="">Seleccionar del cat√°logo...</option>';
                
                select.innerHTML = defaultOption +
                    partsList.map(part => `<option value="${part}">${part}</option>`).join('');
                select.value = currentValue;
            });

            if (currentUser && currentUser.role === 'admin') {
                renderPartsManageList();
            }
        }

        function renderPartsManageList() {
            const list = document.getElementById('partsManageList');
            list.innerHTML = partsList.map((part, index) => `
                <div class="item-entry">
                    <span class="item-name">${part}</span>
                    <button class="btn-danger" onclick="removePartFromList(${index})">üóëÔ∏è Eliminar</button>
                </div>
            `).join('');
        }

        async function addPartToList() {
            const input = document.getElementById('newPartName');
            const name = input.value.trim();
            
            if (!name) {
                alert('Por favor ingresa un nombre para el repuesto');
                return;
            }

            if (partsList.includes(name)) {
                alert('Este repuesto ya existe en el cat√°logo');
                return;
            }

            partsList.push(name);
            
            if (db) {
                await db.ref('partsList').set(partsList);
            } else {
                saveData();
            }

            input.value = '';
            updatePartsDropdowns();
            showNotification('‚úÖ Repuesto agregado al cat√°logo');
        }

        async function removePartFromList(index) {
            if (!confirm('¬øEst√°s seguro de eliminar este repuesto del cat√°logo?')) return;

            partsList.splice(index, 1);
            
            if (db) {
                await db.ref('partsList').set(partsList);
            } else {
                saveData();
            }

            updatePartsDropdowns();
            showNotification('‚úÖ Repuesto eliminado del cat√°logo');
        }

        document.getElementById('partsCatalog').addEventListener('change', function() {
            if (this.value) {
                document.getElementById('partsDescription').value = this.value;
            }
        });

        // ==========================================
        // NOTIFICATION SYSTEM
        // ==========================================
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ==========================================
        // MODAL FUNCTIONS
        // ==========================================
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('active');
            
            if (modalId === 'dailyModal') loadDailyReport();
            if (modalId === 'weeklyModal') loadWeeklyReport();
            if (modalId === 'equipmentModal') loadEquipmentList();
            if (modalId === 'partsRequestsModal') loadPartsRequests();
            if (modalId === 'manageEquipmentModal') renderEquipmentManageList();
            if (modalId === 'managePartsListModal') renderPartsManageList();
            if (modalId === 'manageTypesModal') renderMaintenanceTypesManageList();
            if (modalId === 'chartModal') loadEquipmentChart();
            if (modalId === 'robertModal') loadRobertModal();
            
            if (modalId === 'reportModal') {
                document.getElementById('reportDate').valueAsDate = new Date();
                selectedParts = [];
                renderSelectedParts();
            }
            if (modalId === 'partsModal') {
                document.getElementById('partsDate').valueAsDate = new Date();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // ==========================================
        // REPORT FORM
        // ==========================================
        document.getElementById('reportForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const report = {
                date: document.getElementById('reportDate').value,
                startTime: document.getElementById('reportStartTime').value,
                endTime: document.getElementById('reportEndTime').value,
                totalTime: document.getElementById('reportTotalTime').value,
                type: document.getElementById('reportType').value,
                equipment: document.getElementById('reportEquipment').value,
                status: document.getElementById('reportStatus').value,
                description: document.getElementById('reportDescription').value,
                results: document.getElementById('reportResults').value,
                parts: selectedParts.join(', '),
                recommendations: document.getElementById('reportRecommendations').value,
                mechanic: currentUser.name,
                createdAt: new Date().toISOString()
            };

            if (db) {
                await db.ref('reports').push(report);
            } else {
                allReports.unshift(report);
                saveData();
            }

            autoExportReports();

            showNotification('‚úÖ Informe guardado y exportado autom√°ticamente');
            closeModal('reportModal');
            this.reset();
            selectedParts = [];
            renderSelectedParts();
        });

        document.getElementById('reportEndTime').addEventListener('change', calculateTotalTime);
        document.getElementById('reportStartTime').addEventListener('change', calculateTotalTime);

        function calculateTotalTime() {
            const start = document.getElementById('reportStartTime').value;
            const end = document.getElementById('reportEndTime').value;
            
            if (start && end) {
                const [startHour, startMin] = start.split(':').map(Number);
                const [endHour, endMin] = end.split(':').map(Number);
                
                const startMinutes = startHour * 60 + startMin;
                const endMinutes = endHour * 60 + endMin;
                
                let diff = endMinutes - startMinutes;
                if (diff < 0) diff += 24 * 60;
                
                document.getElementById('reportTotalTime').value = diff;
            }
        }

        // ==========================================
        // PARTS REQUEST FORM
        // ==========================================
        document.getElementById('partsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const request = {
                date: document.getElementById('partsDate').value,
                priority: document.getElementById('partsPriority').value,
                equipment: document.getElementById('partsEquipment').value,
                description: document.getElementById('partsDescription').value,
                quantity: document.getElementById('partsQuantity').value,
                unit: document.getElementById('partsUnit').value,
                reason: document.getElementById('partsReason').value,
                requestedBy: currentUser.name,
                createdAt: new Date().toISOString()
            };

            if (db) {
                await db.ref('partsRequests').push(request);
            } else {
                allPartsRequests.unshift(request);
                saveData();
            }

            autoExportPartsRequests();

            showNotification('‚úÖ Solicitud enviada y exportada autom√°ticamente');
            closeModal('partsModal');
            this.reset();
        });

        // ==========================================
        // AUTO EXPORT FUNCTIONS
        // ==========================================
        function autoExportReports() {
            const ws = XLSX.utils.json_to_sheet(allReports.map(r => ({
                'Fecha': r.date,
                'Mec√°nico': r.mechanic,
                'Equipo': r.equipment,
                'Tipo': r.type,
                'Estado': r.status,
                'Hora Inicio': r.startTime,
                'Hora Fin': r.endTime,
                'Tiempo (min)': r.totalTime,
                'Descripci√≥n': r.description,
                'Resultados': r.results,
                'Recambios': r.parts,
                'Recomendaciones': r.recommendations
            })));
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Operaciones');
            
            const fecha = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `Operaciones_Mantenimiento_${fecha}.xlsx`);
        }

        function autoExportPartsRequests() {
            const ws = XLSX.utils.json_to_sheet(allPartsRequests.map(p => ({
                'Fecha': p.date,
                'Solicitante': p.requestedBy,
                'Equipo': p.equipment,
                'Descripci√≥n': p.description,
                'Cantidad': p.quantity,
                'Unidad': p.unit,
                'Prioridad': p.priority,
                'Motivo': p.reason
            })));
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Solicitudes');
            
            const fecha = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `Solicitudes_Repuestos_${fecha}.xlsx`);
        }

        // ==========================================
        // DAILY REPORT
        // ==========================================
        function loadDailyReport() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            // Filtrar solo reportes con equipos o repuestos
            const dailyReports = allReports.filter(r => {
                return r.date === yesterdayStr && 
                       (r.equipment || (r.parts && r.parts.trim() !== ''));
            });
            
            const stats = {
                total: dailyReports.length,
                resuelto: dailyReports.filter(r => r.status === 'Resuelto').length,
                noResuelto: dailyReports.filter(r => r.status === 'No Resuelto').length,
                enProgreso: dailyReports.filter(r => r.status === 'En Progreso').length,
                totalTime: dailyReports.reduce((sum, r) => sum + parseInt(r.totalTime || 0), 0)
            };
            
            document.getElementById('dailyStats').innerHTML = `
                <div class="stat-box">
                    <div class="stat-number">${stats.total}</div>
                    <div class="stat-label">Total Operaciones</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${stats.resuelto}</div>
                    <div class="stat-label">Resueltos</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${stats.enProgreso}</div>
                    <div class="stat-label">En Progreso</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${Math.round(stats.totalTime / 60)}h ${stats.totalTime % 60}m</div>
                    <div class="stat-label">Tiempo Total</div>
                </div>
            `;
            
            const tbody = document.getElementById('dailyTableBody');
            tbody.innerHTML = dailyReports.map(r => `
                <tr>
                    <td>${r.startTime} - ${r.endTime}</td>
                    <td>${r.mechanic}</td>
                    <td>${r.equipment}</td>
                    <td>${r.type}</td>
                    <td><span class="badge badge-${r.status.toLowerCase().replace(' ', '-')}">${r.status}</span></td>
                    <td>${r.totalTime} min</td>
                </tr>
            `).join('') || '<tr><td colspan="6" class="no-data">No hay reportes con equipos o repuestos del d√≠a anterior</td></tr>';
        }

        // ==========================================
        // WEEKLY REPORT
        // ==========================================
        function loadWeeklyReport() {
            const today = new Date();
            const lastMonday = new Date(today);
            lastMonday.setDate(today.getDate() - today.getDay() - 6);
            
            const lastSunday = new Date(lastMonday);
            lastSunday.setDate(lastMonday.getDate() + 6);
            
            // Filtrar solo reportes con equipos o repuestos
            const weeklyReports = allReports.filter(r => {
                const reportDate = new Date(r.date);
                return reportDate >= lastMonday && 
                       reportDate <= lastSunday &&
                       (r.equipment || (r.parts && r.parts.trim() !== ''));
            });
            
            const stats = {
                total: weeklyReports.length,
                resuelto: weeklyReports.filter(r => r.status === 'Resuelto').length,
                preventive: weeklyReports.filter(r => r.type === 'Preventivo').length,
                corrective: weeklyReports.filter(r => r.type === 'Correctivo').length,
                totalTime: weeklyReports.reduce((sum, r) => sum + parseInt(r.totalTime || 0), 0)
            };
            
            document.getElementById('weeklyStats').innerHTML = `
                <div class="stat-box">
                    <div class="stat-number">${stats.total}</div>
                    <div class="stat-label">Total Operaciones</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${stats.resuelto}</div>
                    <div class="stat-label">Resueltos</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${stats.preventive}</div>
                    <div class="stat-label">Preventivos</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${stats.corrective}</div>
                    <div class="stat-label">Correctivos</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${Math.round(stats.totalTime / 60)}h</div>
                    <div class="stat-label">Tiempo Total</div>
                </div>
            `;
            
            renderWeeklyTable(weeklyReports);
        }

        function renderWeeklyTable(reports) {
            const tbody = document.getElementById('weeklyTableBody');
            tbody.innerHTML = reports.map(r => `
                <tr>
                    <td>${r.date}</td>
                    <td>${r.mechanic}</td>
                    <td>${r.equipment}</td>
                    <td>${r.type}</td>
                    <td><span class="badge badge-${r.status.toLowerCase().replace(' ', '-')}">${r.status}</span></td>
                    <td>${r.totalTime} min</td>
                    <td>${r.description.substring(0, 50)}...</td>
                </tr>
            `).join('') || '<tr><td colspan="7" class="no-data">No hay reportes con equipos o repuestos de la semana anterior</td></tr>';
        }

        function filterWeeklyReports() {
            const typeFilter = document.getElementById('weeklyFilterType').value;
            const statusFilter = document.getElementById('weeklyFilterStatus').value;
            
            const today = new Date();
            const lastMonday = new Date(today);
            lastMonday.setDate(today.getDate() - today.getDay() - 6);
            
            const lastSunday = new Date(lastMonday);
            lastSunday.setDate(lastMonday.getDate() + 6);
            
            // Filtrar solo reportes con equipos o repuestos
            let filtered = allReports.filter(r => {
                const reportDate = new Date(r.date);
                return reportDate >= lastMonday && 
                       reportDate <= lastSunday &&
                       (r.equipment || (r.parts && r.parts.trim() !== ''));
            });
            
            if (typeFilter) filtered = filtered.filter(r => r.type === typeFilter);
            if (statusFilter) filtered = filtered.filter(r => r.status === statusFilter);
            
            renderWeeklyTable(filtered);
        }

        // ==========================================
        // EQUIPMENT REPORTS
        // ==========================================
        function loadEquipmentList() {
            const equipmentStats = {};
            
            allReports.forEach(r => {
                if (!equipmentStats[r.equipment]) {
                    equipmentStats[r.equipment] = {
                        name: r.equipment,
                        total: 0,
                        resuelto: 0,
                        totalTime: 0
                    };
                }
                equipmentStats[r.equipment].total++;
                if (r.status === 'Resuelto') equipmentStats[r.equipment].resuelto++;
                equipmentStats[r.equipment].totalTime += parseInt(r.totalTime || 0);
            });
            
            const equipmentListDiv = document.getElementById('equipmentList');
            equipmentListDiv.innerHTML = Object.values(equipmentStats).map(eq => `
                <div class="equipment-card" onclick="showEquipmentDetail('${eq.name}')">
                    <h3>‚öôÔ∏è ${eq.name}</h3>
                    <div class="equipment-stats">
                        <div class="equipment-stat">
                            <div class="equipment-stat-value">${eq.total}</div>
                            <div class="equipment-stat-label">Operaciones</div>
                        </div>
                        <div class="equipment-stat">
                            <div class="equipment-stat-value">${eq.resuelto}</div>
                            <div class="equipment-stat-label">Resueltos</div>
                        </div>
                        <div class="equipment-stat">
                            <div class="equipment-stat-value">${Math.round(eq.totalTime / 60)}h</div>
                            <div class="equipment-stat-label">Tiempo Total</div>
                        </div>
                    </div>
                </div>
            `).join('') || '<div class="no-data">No hay equipos registrados</div>';
        }

        function filterEquipmentBySelect() {
            const selectedEquipment = document.getElementById('equipmentFilterSelect').value;
            
            if (selectedEquipment) {
                showEquipmentDetail(selectedEquipment);
            } else {
                loadEquipmentList();
            }
        }

        function filterEquipment() {
            const search = document.getElementById('equipmentSearch').value.toLowerCase();
            const cards = document.querySelectorAll('.equipment-card');
            
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(search) ? 'block' : 'none';
            });
        }

        function showEquipmentDetail(equipmentName) {
            currentEquipment = equipmentName;
            const equipmentReports = allReports.filter(r => r.equipment === equipmentName);
            
            document.getElementById('equipmentDetailTitle').textContent = `‚öôÔ∏è ${equipmentName}`;
            
            const stats = {
                total: equipmentReports.length,
                resuelto: equipmentReports.filter(r => r.status === 'Resuelto').length,
                preventive: equipmentReports.filter(r => r.type === 'Preventivo').length,
                corrective: equipmentReports.filter(r => r.type === 'Correctivo').length,
                totalTime: equipmentReports.reduce((sum, r) => sum + parseInt(r.totalTime || 0), 0)
            };
            
            document.getElementById('equipmentDetailStats').innerHTML = `
                <div class="stat-box">
                    <div class="stat-number">${stats.total}</div>
                    <div class="stat-label">Total Operaciones</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${stats.resuelto}</div>
                    <div class="stat-label">Resueltos</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${stats.preventive}</div>
                    <div class="stat-label">Preventivos</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${stats.corrective}</div>
                    <div class="stat-label">Correctivos</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${Math.round(stats.totalTime / 60)}h</div>
                    <div class="stat-label">Tiempo Total</div>
                </div>
            `;
            
            const tbody = document.getElementById('equipmentDetailTableBody');
            tbody.innerHTML = equipmentReports.map(r => `
                <tr>
                    <td>${r.date}</td>
                    <td>${r.mechanic}</td>
                    <td>${r.type}</td>
                    <td><span class="badge badge-${r.status.toLowerCase().replace(' ', '-')}">${r.status}</span></td>
                    <td>${r.totalTime} min</td>
                    <td>${r.description.substring(0, 60)}...</td>
                </tr>
            `).join('');
            
            closeModal('equipmentModal');
            openModal('equipmentDetailModal');
        }

        // ==========================================
        // PARTS REQUESTS
        // ==========================================
        function loadPartsRequests() {
            const stats = {
                total: allPartsRequests.length,
                high: allPartsRequests.filter(p => p.priority === 'Alta').length,
                medium: allPartsRequests.filter(p => p.priority === 'Media').length,
                low: allPartsRequests.filter(p => p.priority === 'Baja').length
            };
            
            document.getElementById('partsRequestsStats').innerHTML = `
                <div class="stat-box">
                    <div class="stat-number">${stats.total}</div>
                    <div class="stat-label">Total Solicitudes</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${stats.high}</div>
                    <div class="stat-label">Prioridad Alta</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${stats.medium}</div>
                    <div class="stat-label">Prioridad Media</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${stats.low}</div>
                    <div class="stat-label">Prioridad Baja</div>
                </div>
            `;
            
            const equipments = [...new Set(allPartsRequests.map(p => p.equipment))];
            const equipmentFilter = document.getElementById('partsFilterEquipment');
            equipmentFilter.innerHTML = '<option value="">Todos</option>' + 
                equipments.map(eq => `<option value="${eq}">${eq}</option>`).join('');
            
            renderPartsTable(allPartsRequests);
        }

        function renderPartsTable(requests) {
            const tbody = document.getElementById('partsRequestsTableBody');
            tbody.innerHTML = requests.map(p => `
                <tr>
                    <td>${p.date}</td>
                    <td>${p.requestedBy}</td>
                    <td>${p.equipment}</td>
                    <td>${p.description.substring(0, 40)}...</td>
                    <td>${p.quantity} ${p.unit}</td>
                    <td><span class="badge badge-${p.priority.toLowerCase()}">${p.priority}</span></td>
                    <td>${p.reason.substring(0, 50)}...</td>
                </tr>
            `).join('') || '<tr><td colspan="7" class="no-data">No hay solicitudes de repuestos</td></tr>';
        }

        function filterPartsRequests() {
            const priorityFilter = document.getElementById('partsFilterPriority').value;
            const equipmentFilter = document.getElementById('partsFilterEquipment').value;
            
            let filtered = [...allPartsRequests];
            
            if (priorityFilter) filtered = filtered.filter(p => p.priority === priorityFilter);
            if (equipmentFilter) filtered = filtered.filter(p => p.equipment === equipmentFilter);
            
            renderPartsTable(filtered);
        }

        // ==========================================
        // INITIALIZE
        // ==========================================
        window.addEventListener('load', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportDate').value = today;
            document.getElementById('partsDate').value = today;
        });
    </script>
</body>
</html>